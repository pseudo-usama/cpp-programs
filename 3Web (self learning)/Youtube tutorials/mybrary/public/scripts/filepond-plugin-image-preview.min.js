(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self,e.FilePondPluginImagePreview=t())})(this,function(){"use strict";function e(e){this.wrapped=e}function t(t){function i(e,t){return new Promise(function(i,a){var c={key:e,arg:t,resolve:i,reject:a,next:null};o?o=o.next=c:(n=o=c,r(e,t))})}function r(i,n){try{var o=t[i](n),c=o.value,s=c instanceof e;Promise.resolve(s?c.wrapped:c).then(function(e){s?r("next",e):a(o.done?"return":"normal",e)},function(e){r("throw",e)})}catch(e){a("throw",e)}}function a(e,t){switch(e){case"return":n.resolve({value:t,done:!0});break;case"throw":n.reject(t);break;default:n.resolve({value:t,done:!1})}n=n.next,n?r(n.key,n.arg):o=null}var n,o;this._invoke=i,"function"!=typeof t.return&&(this.return=void 0)}function i(e,t){return r(e)||a(e,t)||n()}function r(e){if(Array.isArray(e))return e}function a(e,t){var i=[],r=!0,a=!1,n=void 0;try{for(var o,c=e[Symbol.iterator]();!(r=(o=c.next()).done)&&(i.push(o.value),!t||i.length!==t);r=!0);}catch(e){a=!0,n=e}finally{try{r||null==c.return||c.return()}finally{if(a)throw n}}return i}function n(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}var o=function(e){return/^image/.test(e.type)};"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)};var c=function(e,t){return l(e.x*t,e.y*t)},s=function(e,t){return l(e.x+t.x,e.y+t.y)},u=function(e){var t=Math.sqrt(e.x*e.x+e.y*e.y);return 0===t?{x:0,y:0}:l(e.x/t,e.y/t)},h=function(e,t,i){var r=Math.cos(t),a=Math.sin(t),n=l(e.x-i.x,e.y-i.y);return l(i.x+r*n.x-a*n.y,i.y+a*n.x+r*n.y)},l=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return{x:e,y:t}},d=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3?arguments[3]:void 0;return"string"==typeof e?parseFloat(e)*i:"number"==typeof e?e*(r?t[r]:Math.min(t.width,t.height)):void 0},f=function(e,t,i){var r=e.borderStyle||e.lineStyle||"solid",a=e.backgroundColor||e.fontColor||"transparent",n=e.borderColor||e.lineColor||"transparent",o=d(e.borderWidth||e.lineWidth,t,i),c=e.lineCap||"round",s=e.lineJoin||"round",u="string"==typeof r?"":r.map(function(e){return d(e,t,i)}).join(","),h=e.opacity||1;return{"stroke-linecap":c,"stroke-linejoin":s,"stroke-width":o||0,"stroke-dasharray":u,stroke:n,fill:a,opacity:h}},g=function(e){return null!=e},p=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=d(e.x,t,i,"width")||d(e.left,t,i,"width"),a=d(e.y,t,i,"height")||d(e.top,t,i,"height"),n=d(e.width,t,i,"width"),o=d(e.height,t,i,"height"),c=d(e.right,t,i,"width"),s=d(e.bottom,t,i,"height");return g(a)||(a=g(o)&&g(s)?t.height-o-s:s),g(r)||(r=g(n)&&g(c)?t.width-n-c:c),g(n)||(n=g(r)&&g(c)?t.width-r-c:0),g(o)||(o=g(a)&&g(s)?t.height-a-s:0),{x:r||0,y:a||0,width:n||0,height:o||0}},m=function(e){return e.map(function(e,t){return"".concat(0===t?"M":"L"," ").concat(e.x," ").concat(e.y)}).join(" ")},y=function(e,t){return Object.keys(t).forEach(function(i){return e.setAttribute(i,t[i])})},v="http://www.w3.org/2000/svg",E=function(e,t){var i=document.createElementNS(v,e);return t&&y(i,t),i},w=function(e){return y(e,Object.assign({},e.rect,e.styles))},_=function(e){var t=e.rect.x+.5*e.rect.width,i=e.rect.y+.5*e.rect.height,r=.5*e.rect.width,a=.5*e.rect.height;return y(e,Object.assign({cx:t,cy:i,rx:r,ry:a},e.styles))},I={contain:"xMidYMid meet",cover:"xMidYMid slice"},M=function(e,t){y(e,Object.assign({},e.rect,e.styles,{preserveAspectRatio:I[t.fit]||"none"}))},x={left:"start",center:"middle",right:"end"},T=function(e,t,i,r){var a=d(t.fontSize,i,r),n=t.fontFamily||"sans-serif",o=t.fontWeight||"normal",c=x[t.textAlign]||"start";y(e,Object.assign({},e.rect,e.styles,{"stroke-width":0,"font-weight":o,"font-size":a,"font-family":n,"text-anchor":c})),e.text!==t.text&&(e.text=t.text,e.textContent=t.text.length?t.text:" ")},A=function(e,t,i,r){y(e,Object.assign({},e.rect,e.styles,{fill:"none"}));var a=e.childNodes[0],n=e.childNodes[1],o=e.childNodes[2],l=e.rect,f={x:e.rect.x+e.rect.width,y:e.rect.y+e.rect.height};if(y(a,{x1:l.x,y1:l.y,x2:f.x,y2:f.y}),t.lineDecoration){n.style.display="none",o.style.display="none";var g=u({x:f.x-l.x,y:f.y-l.y}),p=d(.05,i,r);if(-1!==t.lineDecoration.indexOf("arrow-begin")){var m=c(g,p),v=s(l,m),E=h(l,2,v),w=h(l,-2,v);y(n,{style:"display:block;",d:"M".concat(E.x,",").concat(E.y," L").concat(l.x,",").concat(l.y," L").concat(w.x,",").concat(w.y)})}if(-1!==t.lineDecoration.indexOf("arrow-end")){var _=c(g,-p),I=s(f,_),M=h(f,2,I),x=h(f,-2,I);y(o,{style:"display:block;",d:"M".concat(M.x,",").concat(M.y," L").concat(f.x,",").concat(f.y," L").concat(x.x,",").concat(x.y)})}}},R=function(e,t,i,r){y(e,Object.assign({},e.styles,{fill:"none",d:m(t.points.map(function(e){return{x:d(e.x,i,r,"width"),y:d(e.y,i,r,"height")}}))}))},P=function(e){return function(t){return E(e,{id:t.id})}},C=function(e){var t=E("image",{id:e.id,"stroke-linecap":"round","stroke-linejoin":"round",opacity:"0"});return t.onload=function(){t.setAttribute("opacity",e.opacity||1)},t.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e.src),t},k=function(e){var t=E("g",{id:e.id,"stroke-linecap":"round","stroke-linejoin":"round"}),i=E("line");t.appendChild(i);var r=E("path");t.appendChild(r);var a=E("path");return t.appendChild(a),t},D={image:C,rect:P("rect"),ellipse:P("ellipse"),text:P("text"),path:P("path"),line:k},G={rect:w,ellipse:_,image:M,text:T,path:R,line:A},V=function(e,t){return D[e](t)},O=function(e,t,i,r,a){"path"!==t&&(e.rect=p(i,r,a)),e.styles=f(i,r,a),G[t](e,i,r,a)},b=["x","y","left","top","right","bottom","width","height"],S=function(e){return"string"==typeof e&&/%/.test(e)?parseFloat(e)/100:e},L=function(e){var t=i(e,2),r=t[0],a=t[1],n=a.points?{}:b.reduce(function(e,t){return e[t]=S(a[t]),e},{});return[r,Object.assign({zIndex:0},a,n)]},N=function(e,t){return e[1].zIndex>t[1].zIndex?1:e[1].zIndex<t[1].zIndex?-1:0},W=function(e){return e.utils.createView({name:"image-preview-markup",tag:"svg",ignoreRect:!0,mixins:{apis:["width","height","crop","markup","resize","dirty"]},write:function(e){var t=e.root,r=e.props;if(r.dirty){var a=r.crop,n=r.resize,o=r.markup,c=r.width,s=r.height,u=a.width,h=a.height;if(n){var l=n.size,d=l&&l.width,f=l&&l.height,g=n.mode,p=n.upscale;d&&!f&&(f=d),f&&!d&&(d=f);var m=u<d&&h<f;if(!m||m&&p){var y,v=d/u,E=f/h;if("force"===g)u=d,h=f;else"cover"===g?y=Math.max(v,E):"contain"===g&&(y=Math.min(v,E)),u*=y,h*=y}}var w={width:c,height:s};t.element.setAttribute("width",w.width),t.element.setAttribute("height",w.height);var _=Math.min(c/u,s/h);t.element.innerHTML="";var I=t.query("GET_IMAGE_PREVIEW_MARKUP_FILTER");o.filter(I).map(L).sort(N).forEach(function(e){var r=i(e,2),a=r[0],n=r[1],o=V(a,n);O(o,a,n,w,_),t.element.appendChild(o)})}}})},z=function(e,t){return{x:e,y:t}},H=function(e,t){return e.x*t.x+e.y*t.y},q=function(e,t){return z(e.x-t.x,e.y-t.y)},F=function(e,t){return H(q(e,t),q(e,t))},U=function(e,t){return Math.sqrt(F(e,t))},Y=function(e,t){var i=e,r=1.5707963267948966,a=t,n=1.5707963267948966-t,o=Math.sin(r),c=Math.sin(a),s=Math.sin(n),u=Math.cos(n),h=i/o,l=h*c,d=h*s;return z(u*l,u*d)},X=function(e,t){var i=e.width,r=e.height,a=Y(i,t),n=Y(r,t),o=z(e.x+Math.abs(a.x),e.y-Math.abs(a.y)),c=z(e.x+e.width+Math.abs(n.y),e.y+Math.abs(n.x)),s=z(e.x-Math.abs(n.y),e.y+e.height-Math.abs(n.x));return{width:U(o,c),height:U(o,s)}},j=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=e.height/e.width,a=1,n=t,o=1,c=r;c>n&&(c=n,o=c/r);var s=Math.max(a/o,n/c),u=e.width/(i*s*o),h=u*t;return{width:u,height:h}},B=function(e,t,i,r){var a=r.x>.5?1-r.x:r.x,n=r.y>.5?1-r.y:r.y,o=2*a*e.width,c=2*n*e.height,s=X(t,i);return Math.max(s.width/o,s.height/c)},Z=function(e,t){var i=e.width,r=i*t;r>e.height&&(r=e.height,i=r/t);var a=.5*(e.width-i),n=.5*(e.height-r);return{x:a,y:n,width:i,height:r}},K=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t.zoom,r=t.rotation,a=t.center,n=t.aspectRatio;n||(n=e.height/e.width);var o=j(e,n,i),c={x:.5*o.width,y:.5*o.height},s={x:0,y:0,width:o.width,height:o.height,center:c},u=void 0===t.scaleToFit||t.scaleToFit,h=B(e,Z(s,n),r,u?a:{x:.5,y:.5}),l=i*h;return{widthFloat:o.width/l,heightFloat:o.height/l,width:Math.round(o.width/l),height:Math.round(o.height/l)}},J={type:"spring",stiffness:.5,damping:.45,mass:10},Q=function(e){return e.utils.createView({name:"image-bitmap",ignoreRect:!0,mixins:{styles:["scaleX","scaleY"]},create:function(e){var t=e.root,i=e.props;t.appendChild(i.image)}})},$=function(e){return e.utils.createView({name:"image-canvas-wrapper",tag:"div",ignoreRect:!0,mixins:{apis:["crop","width","height"],styles:["originX","originY","translateX","translateY","scaleX","scaleY","rotateZ"],animations:{originX:J,originY:J,scaleX:J,scaleY:J,translateX:J,translateY:J,rotateZ:J}},create:function(t){var i=t.root,r=t.props;r.width=r.image.width,r.height=r.image.height,i.ref.bitmap=i.appendChildView(i.createChildView(Q(e),{image:r.image}))},write:function(e){var t=e.root,i=e.props,r=i.crop.flip,a=t.ref.bitmap;a.scaleX=r.horizontal?-1:1,a.scaleY=r.vertical?-1:1}})},ee=function(e){return e.utils.createView({name:"image-clip",tag:"div",ignoreRect:!0,mixins:{apis:["crop","markup","resize","width","height","dirty","background"],styles:["width","height","opacity"],animations:{opacity:{type:"tween",duration:250}}},didWriteView:function(e){var t=e.root,i=e.props;i.background&&(t.element.style.backgroundColor=i.background)},create:function(t){var i=t.root,r=t.props;i.ref.image=i.appendChildView(i.createChildView($(e),Object.assign({},r))),i.ref.createMarkup=function(){i.ref.markup||(i.ref.markup=i.appendChildView(i.createChildView(W(e),Object.assign({},r))))},i.ref.destroyMarkup=function(){i.ref.markup&&(i.removeChildView(i.ref.markup),i.ref.markup=null)};var a=i.query("GET_IMAGE_PREVIEW_TRANSPARENCY_INDICATOR");null!==a&&(i.element.dataset.transparencyIndicator="grid"===a?a:"color")},write:function(e){var t=e.root,i=e.props,r=e.shouldOptimize,a=i.crop,n=i.markup,o=i.resize,c=i.dirty,s=i.width,u=i.height;t.ref.image.crop=a;var h={x:0,y:0,width:s,height:u,center:{x:.5*s,y:.5*u}},l={width:t.ref.image.width,height:t.ref.image.height},d={x:a.center.x*l.width,y:a.center.y*l.height},f={x:h.center.x-l.width*a.center.x,y:h.center.y-l.height*a.center.y},g=2*Math.PI+a.rotation%(2*Math.PI),p=a.aspectRatio||l.height/l.width,m=void 0===a.scaleToFit||a.scaleToFit,y=B(l,Z(h,p),g,m?a.center:{x:.5,y:.5}),v=a.zoom*y;n&&n.length?(t.ref.createMarkup(),t.ref.markup.width=s,t.ref.markup.height=u,t.ref.markup.resize=o,t.ref.markup.dirty=c,t.ref.markup.markup=n,t.ref.markup.crop=K(l,a)):t.ref.markup&&t.ref.destroyMarkup();var E=t.ref.image;if(r)return E.originX=null,E.originY=null,E.translateX=null,E.translateY=null,E.rotateZ=null,E.scaleX=null,void(E.scaleY=null);E.originX=d.x,E.originY=d.y,E.translateX=f.x,E.translateY=f.y,E.rotateZ=g,E.scaleX=v,E.scaleY=v}})},te=function(e){return e.utils.createView({name:"image-preview",tag:"div",ignoreRect:!0,mixins:{apis:["image","crop","markup","resize","dirty","background"],styles:["translateY","scaleX","scaleY","opacity"],animations:{scaleX:J,scaleY:J,translateY:J,opacity:{type:"tween",duration:400}}},create:function(t){var i=t.root,r=t.props;i.ref.clip=i.appendChildView(i.createChildView(ee(e),{id:r.id,image:r.image,crop:r.crop,markup:r.markup,resize:r.resize,dirty:r.dirty,background:r.background}))},write:function(e){var t=e.root,i=e.props,r=e.shouldOptimize,a=t.ref.clip,n=i.image,o=i.crop,c=i.markup,s=i.resize,u=i.dirty;if(a.crop=o,a.markup=c,a.resize=s,a.dirty=u,a.opacity=r?0:1,!r&&!t.rect.element.hidden){var h=n.height/n.width,l=o.aspectRatio||h,d=t.rect.inner.width,f=t.rect.inner.height,g=t.query("GET_IMAGE_PREVIEW_HEIGHT"),p=t.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),m=t.query("GET_IMAGE_PREVIEW_MAX_HEIGHT"),y=t.query("GET_PANEL_ASPECT_RATIO"),v=t.query("GET_ALLOW_MULTIPLE");y&&!v&&(g=d*y,l=y);var E=null!==g?g:Math.max(p,Math.min(d*l,m)),w=E/l;w>d&&(w=d,E=w*l),E>f&&(E=f,w=f/l),a.width=w,a.height=E}}})},ie='<svg width="500" height="200" viewBox="0 0 500 200" preserveAspectRatio="none">\n    <defs>\n        <radialGradient id="gradient-__UID__" cx=".5" cy="1.25" r="1.15">\n            <stop offset=\'50%\' stop-color=\'#000000\'/>\n            <stop offset=\'56%\' stop-color=\'#0a0a0a\'/>\n            <stop offset=\'63%\' stop-color=\'#262626\'/>\n            <stop offset=\'69%\' stop-color=\'#4f4f4f\'/>\n            <stop offset=\'75%\' stop-color=\'#808080\'/>\n            <stop offset=\'81%\' stop-color=\'#b1b1b1\'/>\n            <stop offset=\'88%\' stop-color=\'#dadada\'/>\n            <stop offset=\'94%\' stop-color=\'#f6f6f6\'/>\n            <stop offset=\'100%\' stop-color=\'#ffffff\'/>\n        </radialGradient>\n        <mask id="mask-__UID__">\n            <rect x="0" y="0" width="500" height="200" fill="url(#gradient-__UID__)"></rect>\n        </mask>\n    </defs>\n    <rect x="0" width="500" height="200" fill="currentColor" mask="url(#mask-__UID__)"></rect>\n</svg>',re=!1,ae=0,ne=function(e){return e.utils.createView({name:"image-preview-overlay",tag:"div",ignoreRect:!0,create:function(e){var t=e.root,i=e.props;!re&&document.querySelector("base")&&(ie=ie.replace(/url\(\#/g,"url("+window.location.href.replace(window.location.hash,"")+"#"),re=!0),ae++,t.element.classList.add("filepond--image-preview-overlay-".concat(i.status)),t.element.innerHTML=ie.replace(/__UID__/g,ae)},mixins:{styles:["opacity"],animations:{opacity:{type:"spring",mass:25}}}})},oe=function(){self.onmessage=function(e){createImageBitmap(e.data.message.file).then(function(t){self.postMessage({id:e.data.id,message:t},[t])})}},ce=function(){self.onmessage=function(e){for(var t=e.data.message.imageData,i=e.data.message.colorMatrix,r=t.data,a=r.length,n=i[0],o=i[1],c=i[2],s=i[3],u=i[4],h=i[5],l=i[6],d=i[7],f=i[8],g=i[9],p=i[10],m=i[11],y=i[12],v=i[13],E=i[14],w=i[15],_=i[16],I=i[17],M=i[18],x=i[19],T=0,A=0,R=0,P=0,C=0;T<a;T+=4)A=r[T]/255,R=r[T+1]/255,P=r[T+2]/255,C=r[T+3]/255,r[T]=Math.max(0,Math.min(255*(A*n+R*o+P*c+C*s+u),255)),r[T+1]=Math.max(0,Math.min(255*(A*h+R*l+P*d+C*f+g),255)),r[T+2]=Math.max(0,Math.min(255*(A*p+R*m+P*y+C*v+E),255)),r[T+3]=Math.max(0,Math.min(255*(A*w+R*_+P*I+C*M+x),255));self.postMessage({id:e.data.id,message:t},[t.data.buffer])}},se=function(e,t){var i=new Image;i.onload=function(){var e=i.naturalWidth,r=i.naturalHeight;i=null,t(e,r)},i.src=e},ue={1:function(){return[1,0,0,1,0,0]},2:function(e){return[-1,0,0,1,e,0]},3:function(e,t){return[-1,0,0,-1,e,t]},4:function(e,t){return[1,0,0,-1,0,t]},5:function(){return[0,1,1,0,0,0]},6:function(e,t){return[0,1,-1,0,t,0]},7:function(e,t){return[0,-1,-1,0,t,e]},8:function(e){return[0,-1,1,0,0,e]}},he=function(e,t,i,r){-1!==r&&e.transform.apply(e,ue[r](t,i))},le=function(e,t,i,r){t=Math.round(t),i=Math.round(i);var a=document.createElement("canvas");a.width=t,a.height=i;var n=a.getContext("2d");if(r>=5&&r<=8){var o=[i,t];t=o[0],i=o[1]}return he(n,t,i,r),n.drawImage(e,0,0,t,i),a},de=function(e){return/^image/.test(e.type)&&!/svg/.test(e.type)},fe=10,ge=10,pe=function(e){var t=Math.min(fe/e.width,ge/e.height),i=document.createElement("canvas"),r=i.getContext("2d"),a=i.width=Math.ceil(e.width*t),n=i.height=Math.ceil(e.height*t);r.drawImage(e,0,0,a,n);var o=null;try{o=r.getImageData(0,0,a,n).data}catch(e){return null}for(var c=o.length,s=0,u=0,h=0,l=0;l<c;l+=4)s+=o[l]*o[l],u+=o[l+1]*o[l+1],h+=o[l+2]*o[l+2];return s=me(s,c),u=me(u,c),h=me(h,c),{r:s,g:u,b:h}},me=function(e,t){return Math.floor(Math.sqrt(e/(t/4)))},ye=function(e,t){t=t||document.createElement("canvas"),t.width=e.width,t.height=e.height;var i=t.getContext("2d");return i.drawImage(e,0,0),t},ve=function(e){var t;try{t=new ImageData(e.width,e.height)}catch(a){var i=document.createElement("canvas"),r=i.getContext("2d");t=r.createImageData(e.width,e.height)}return t.data.set(new Uint8ClampedArray(e.data)),t},Ee=function(e){return new Promise(function(t,i){var r=new Image;r.crossOrigin="Anonymous",r.onload=function(){t(r)},r.onerror=function(e){i(e)},r.src=e})},we=function(e){var t=ne(e),i=te(e),r=e.utils.createWorker,a=function(e,t,i){return new Promise(function(a){e.ref.imageData||(e.ref.imageData=i.getContext("2d").getImageData(0,0,i.width,i.height));var n=ve(e.ref.imageData);if(!t||20!==t.length)return i.getContext("2d").putImageData(n,0,0),a();var o=r(ce);o.post({imageData:n,colorMatrix:t},function(e){i.getContext("2d").putImageData(e,0,0),o.terminate(),a()},[n.data.buffer])})},n=function(e,t){e.removeChildView(t),t.image.width=1,t.image.height=1,t._destroy()},o=function(e){var t=e.root,i=t.ref.images.shift();return i.opacity=0,i.translateY=-15,t.ref.imageViewBin.push(i),i},c=function(e){var t=e.root,r=e.props,a=e.image,n=r.id,o=t.query("GET_ITEM",{id:n});if(o){var c,s,u=o.getMetadata("crop")||{center:{x:.5,y:.5},flip:{horizontal:!1,vertical:!1},zoom:1,rotation:0,aspectRatio:null},h=t.query("GET_IMAGE_TRANSFORM_CANVAS_BACKGROUND_COLOR"),l=!1;t.query("GET_IMAGE_PREVIEW_MARKUP_SHOW")&&(c=o.getMetadata("markup")||[],s=o.getMetadata("resize"),l=!0);var d=t.appendChildView(t.createChildView(i,{id:n,image:a,crop:u,resize:s,markup:c,dirty:l,background:h,opacity:0,scaleX:1.15,scaleY:1.15,translateY:15}),t.childViews.length);t.ref.images.push(d),d.opacity=1,d.scaleX=1,d.scaleY=1,d.translateY=0,setTimeout(function(){t.dispatch("DID_IMAGE_PREVIEW_SHOW",{id:n})},250)}},s=function(e){var t=e.root,i=e.props,r=t.query("GET_ITEM",{id:i.id});if(r){var a=t.ref.images[t.ref.images.length-1];a.crop=r.getMetadata("crop"),a.background=t.query("GET_IMAGE_TRANSFORM_CANVAS_BACKGROUND_COLOR"),t.query("GET_IMAGE_PREVIEW_MARKUP_SHOW")&&(a.dirty=!0,a.resize=r.getMetadata("resize"),a.markup=r.getMetadata("markup"))}},u=function(e){var t=e.root,i=e.props,r=e.action;if(/crop|filter|markup|resize/.test(r.change.key)&&t.ref.images.length){var n=t.query("GET_ITEM",{id:i.id});if(n)if(/filter/.test(r.change.key)){var u=t.ref.images[t.ref.images.length-1];a(t,r.change.value,u.image)}else if(/crop|markup|resize/.test(r.change.key)){var h=n.getMetadata("crop"),l=t.ref.images[t.ref.images.length-1];if(Math.abs(h.aspectRatio-l.crop.aspectRatio)>1e-5){var d=o({root:t});c({root:t,props:i,image:ye(d.image)})}else s({root:t,props:i})}}},h=function(e){var t=window.navigator.userAgent,i=t.match(/Firefox\/([0-9]+)\./),r=i?parseInt(i[1]):null;return!(r<=58)&&("createImageBitmap"in window&&de(e))},l=function(e){var t=e.root,i=e.props,r=i.id,a=t.query("GET_ITEM",r);if(a){var n=URL.createObjectURL(a.file);se(n,function(e,i){t.dispatch("DID_IMAGE_PREVIEW_CALCULATE_SIZE",{id:r,width:e,height:i})})}},d=function(e){var t=e.root,i=e.props,n=i.id,o=t.query("GET_ITEM",n);if(o){var s=URL.createObjectURL(o.file),u=function(){Ee(s).then(l)},l=function(e){URL.revokeObjectURL(s);var r=o.getMetadata("exif")||{},n=r.orientation||-1,u=e.width,h=e.height;if(n>=5&&n<=8){var l=[h,u];u=l[0],h=l[1]}var d=Math.max(1,.75*window.devicePixelRatio),f=t.query("GET_IMAGE_PREVIEW_ZOOM_FACTOR"),g=f*d,p=h/u,m=t.rect.element.width,y=t.rect.element.height,v=m,E=v*p;p>1?(v=Math.min(u,m*g),E=v*p):(E=Math.min(h,y*g),v=E/p);var w=le(e,v,E,n),_=function(){var r=t.query("GET_IMAGE_PREVIEW_CALCULATE_AVERAGE_IMAGE_COLOR")?pe(data):null;o.setMetadata("color",r,!0),"close"in e&&e.close(),t.ref.overlayShadow.opacity=1,c({root:t,props:i,image:w})},I=o.getMetadata("filter");I?a(t,I,w).then(_):_()};if(h(o.file)){var d=r(oe);d.post({file:o.file},function(e){d.terminate(),e?l(e):u()})}else u()}},f=function(e){var t=e.root,i=t.ref.images[t.ref.images.length-1];i.translateY=0,i.scaleX=1,i.scaleY=1,i.opacity=1},g=function(e){var t=e.root;t.ref.overlayShadow.opacity=1,t.ref.overlayError.opacity=0,t.ref.overlaySuccess.opacity=0},p=function(e){var t=e.root;t.ref.overlayShadow.opacity=.25,t.ref.overlayError.opacity=1},m=function(e){var t=e.root;t.ref.overlayShadow.opacity=.25,t.ref.overlaySuccess.opacity=1},y=function(e){var i=e.root;i.ref.images=[],i.ref.imageData=null,i.ref.imageViewBin=[],i.ref.overlayShadow=i.appendChildView(i.createChildView(t,{opacity:0,status:"idle"})),i.ref.overlaySuccess=i.appendChildView(i.createChildView(t,{opacity:0,status:"success"})),i.ref.overlayError=i.appendChildView(i.createChildView(t,{opacity:0,status:"failure"}))};return e.utils.createView({name:"image-preview-wrapper",create:y,styles:["height"],apis:["height"],destroy:function(e){var t=e.root;t.ref.images.forEach(function(e){e.image.width=1,e.image.height=1})},didWriteView:function(e){var t=e.root;t.ref.images.forEach(function(e){e.dirty=!1})},write:e.utils.createRoute({DID_IMAGE_PREVIEW_DRAW:f,DID_IMAGE_PREVIEW_CONTAINER_CREATE:l,DID_FINISH_CALCULATE_PREVIEWSIZE:d,DID_UPDATE_ITEM_METADATA:u,DID_THROW_ITEM_LOAD_ERROR:p,DID_THROW_ITEM_PROCESSING_ERROR:p,DID_THROW_ITEM_INVALID:p,DID_COMPLETE_ITEM_PROCESSING:m,DID_START_ITEM_PROCESSING:g,DID_REVERT_ITEM_PROCESSING:g},function(e){var t=e.root,i=t.ref.imageViewBin.filter(function(e){return 0===e.opacity});t.ref.imageViewBin=t.ref.imageViewBin.filter(function(e){return e.opacity>0}),i.forEach(function(e){return n(t,e)}),i.length=0})})},_e=function(e){var t=e.addFilter,i=e.utils,r=i.Type,a=i.createRoute,n=i.isFile,c=we(e);return t("CREATE_VIEW",function(e){var t=e.is,i=e.view,r=e.query;if(t("file")&&r("GET_ALLOW_IMAGE_PREVIEW")){var s=function(e){var t=e.root,a=e.props,s=a.id,u=r("GET_ITEM",s);if(u&&n(u.file)&&!u.archived){var h=u.file;if(o(h)&&r("GET_IMAGE_PREVIEW_FILTER_ITEM")(u)){var l="createImageBitmap"in(window||{}),d=r("GET_IMAGE_PREVIEW_MAX_FILE_SIZE");if(!(!l&&d&&h.size>d)){t.ref.imagePreview=i.appendChildView(i.createChildView(c,{id:s}));var f=t.query("GET_IMAGE_PREVIEW_HEIGHT");f&&t.dispatch("DID_UPDATE_PANEL_HEIGHT",{id:u.id,height:f});var g=!l&&h.size>r("GET_IMAGE_PREVIEW_MAX_INSTANT_PREVIEW_FILE_SIZE");t.dispatch("DID_IMAGE_PREVIEW_CONTAINER_CREATE",{id:s},g)}}}},u=function(e,t){if(e.ref.imagePreview){var i=t.id,r=e.query("GET_ITEM",{id:i});if(r){var a=e.query("GET_PANEL_ASPECT_RATIO"),n=e.query("GET_ITEM_PANEL_ASPECT_RATIO"),o=e.query("GET_IMAGE_PREVIEW_HEIGHT");if(!(a||n||o)){var c=e.ref,s=c.imageWidth,u=c.imageHeight;if(s&&u){var h=e.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),l=e.query("GET_IMAGE_PREVIEW_MAX_HEIGHT"),d=r.getMetadata("exif")||{},f=d.orientation||-1;if(f>=5&&f<=8){var g=[u,s];s=g[0],u=g[1]}if(!de(r.file)||e.query("GET_IMAGE_PREVIEW_UPSCALE")){var p=2048/s;s*=p,u*=p}var m=u/s,y=(r.getMetadata("crop")||{}).aspectRatio||m,v=Math.max(h,Math.min(u,l)),E=e.rect.element.width,w=Math.min(E*y,v);e.dispatch("DID_UPDATE_PANEL_HEIGHT",{id:r.id,height:w})}}}}},h=function(e){var t=e.root;t.ref.shouldRescale=!0},l=function(e){var t=e.root,i=e.action;"crop"===i.change.key&&(t.ref.shouldRescale=!0)},d=function(e){var t=e.root,i=e.action;t.ref.imageWidth=i.width,t.ref.imageHeight=i.height,t.ref.shouldRescale=!0,t.ref.shouldDrawPreview=!0,t.dispatch("KICK")};i.registerWriter(a({DID_RESIZE_ROOT:h,DID_STOP_RESIZE:h,DID_LOAD_ITEM:s,DID_IMAGE_PREVIEW_CALCULATE_SIZE:d,DID_UPDATE_ITEM_METADATA:l},function(e){var t=e.root,i=e.props;t.ref.imagePreview&&(t.rect.element.hidden||(t.ref.shouldRescale&&(u(t,i),t.ref.shouldRescale=!1),t.ref.shouldDrawPreview&&(requestAnimationFrame(function(){t.dispatch("DID_FINISH_CALCULATE_PREVIEWSIZE",{id:i.id})}),t.ref.shouldDrawPreview=!1)))}))}}),{options:{allowImagePreview:[!0,r.BOOLEAN],imagePreviewFilterItem:[function(){return!0},r.FUNCTION],imagePreviewHeight:[null,r.INT],imagePreviewMinHeight:[44,r.INT],imagePreviewMaxHeight:[256,r.INT],imagePreviewMaxFileSize:[null,r.INT],imagePreviewZoomFactor:[2,r.INT],imagePreviewUpscale:[!1,r.BOOLEAN],imagePreviewMaxInstantPreviewFileSize:[1e6,r.INT],imagePreviewTransparencyIndicator:[null,r.STRING],imagePreviewCalculateAverageImageColor:[!1,r.BOOLEAN],imagePreviewMarkupShow:[!0,r.BOOLEAN],imagePreviewMarkupFilter:[function(){return!0},r.FUNCTION]}}},Ie="undefined"!=typeof window&&void 0!==window.document;return Ie&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:_e})),_e});